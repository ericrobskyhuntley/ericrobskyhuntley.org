{% extends "blog/base.html" %}
{% load static %}

{% block content %}
<div class="row">
  <div class="col-md-4 offset-1">
    <img class="author-photo" src="{{ author_detail.photo.url }}"/>
  </div>
  <div class="col-md-6">
  <h3>{{ author_detail.full_name }}</h3>

  <code><a href="mailto:{{ author_detail.email }}">{{ author_detail.email }}</a></code>
  <hr>
  {% for affiliation in author_detail.sorted_affiliation %}
    <ul class="list-unstyled small-text">
      <li><em>{{ affiliation.title }}</em></li>
      <li>{{ affiliation.institution.dpt }}, {{ affiliation.institution.inst }}</li>
      <!-- <li>{{ affiliation.institution.loc_geojson }}</li> -->
    </ul>
  {% endfor %}
  <p>{{ author_detail.formatted_markdown|safe }}</p>
  </div>
</div>
<div class="row">
  <div class="col-md-10 offset-1">
    <div id="author_map"></div>
  </div>
</div>
<!-- <div class="row">
  <div class="col-md-10 offset-1">
    <div id="author_map"></div>
  </div>
</div> -->
<script src="{% static 'd3-geo-projection/dist/d3-geo-projection.min.js' %}" type="text/javascript"></script>
<script src="{% static 'd3/dist/d3.min.js' %}" type="text/javascript"></script>
<script src="{% static 'topojson/dist/topojson.min.js' %}" type="text/javascript"></script>
<script type="text/javascript">

  // authormapLeaflet('{{author_detail|escapejs}}', 'author_map')

  const w = 960;
  const h = 400;

  const svg = d3.select("#author_map")
    .append("svg")
    .attr("width", w)
    .attr("height", h);

  let prj = d3.geoOrthographic()
    .rotate([76, -38, 32])
    .scale(1800)

  // geoSatellite()
  //     .translate([w / 2, h / 2])
  //     .scale(1000)
  //     .center([-5, 5])
  //     .rotate([76, -34, 32])
  //     .tilt(25)
  //     .distance(1.6)
  //     .clipAngle(Math.acos(1 / 1.1) * 180 / Math.PI)
  //     .precision(0.1);

  const path = d3.geoPath().projection(prj);

  var affil_locs = {{author_detail.loc_geojson|safe}};

  var ua = {{ua_all|safe}};
  var land = {{land_all|safe}};

  let graticule_10 = d3.geoGraticule().step([10, 10])();
  let graticule_05 = d3.geoGraticule().step([5, 5])();
  let graticule_01 = d3.geoGraticule().step([1, 1])();

  Promise.all([ua, affil_locs, graticule_10, graticule_05, graticule_01, land]).then(function(data){

    var symbolGenerator = d3.symbol()
	     .size(100);

   var land_area = svg.selectAll('path.land')
     .data(land.features)
     .enter()
     .append("path")
     .classed('land', true)
     .attr("d", path);

    // 1 degree graticule.
    var urban_area = svg.selectAll('path.ua')
      .data(ua.features)
      .enter()
      .append("path")
      .classed('ua', true)
      .attr("d", path);

    // 10 degree graticule.
    var grat_10 = svg.selectAll('path.graticule_10')
      .data([data[2]])
      .enter()
      .append('path')
      .classed('graticule_10', true)
      .attr('d', path);

    // 5 degree graticule.
    var grat_05 = svg.selectAll('path.graticule_05')
      .data([data[3]])
      .enter()
      .append('path')
      .classed('graticule_05', true)
      .attr('d', path)
      .exit().remove();

    // 1 degree graticule.
    var grat_01 = svg.selectAll('path.graticule_01')
      .data([data[4]])
      .enter()
      .append('path')
      .classed('graticule_01', true)
      .attr('d', path)
      .exit().remove();

    var sphere = svg.selectAll('path.sphere')
      .data([{type: 'Sphere'}])
      .enter().append('path').classed('sphere', true)
      .attr('d', path)
      .exit().remove();

    var locs = svg.selectAll("circle")
        .data(data[1].features)
      .enter()
        .append("circle")
        .attr("cx", function (d) {
          return prj(d.geometry.coordinates)[0];
        })
        .attr("cy", function (d) {
          return prj(d.geometry.coordinates)[1];
        })
        .style("stroke", "white")
        .style("fill", "#CC003E")
        .style("opacity", 0.7)
        .attr("r", 4);

    var labels = d3.select("#author_map").selectAll("div.label")
        .data(data[1].features).enter()
        .append("div")
          .classed('label small-text', true)
          .style("position", "absolute")
          .style("opacity", 1)
          .style("left", function(d) {
            return prj(d.geometry.coordinates)[0] + "px";
          })
          .style('top', function(d) {
            return prj(d.geometry.coordinates)[1] + "px";
          })
          .html(function(d) {
            return d.properties.dpt + "<br>" + d.properties.inst + "<br>" + d.properties.city + ", " + d.properties.state;
          });

    // labels.selectAll(".label")
    //   .data(data[1].features)
    //   .enter()
    //   .append("div")
    //   .style('position','absolute')
    //   .style('left', function(d) {
    //     return prj(d.geometry.coordinates)[0] + 10;
    //   })
    //   .style('top', function(d) {
    //     return prj(d.geometry.coordinates)[1] - 10;
    //   })
    //   .text(function(d) {
    //       return d.properties.inst;
    //   })
    //   .append('br');
  })

</script>

{% endblock%}
